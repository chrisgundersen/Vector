@page "/queue"
@using MediatR
@using Microsoft.AspNetCore.SignalR.Client
@using Vector.Application.Submissions.DTOs
@using Vector.Application.Submissions.Queries
@using Vector.Domain.Submission.Enums
@inject IMediator Mediator
@inject NavigationManager Navigation
@implements IAsyncDisposable
@attribute [Authorize]

<PageTitle>Submission Queue - Vector</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Submission Queue</h1>
            <p class="text-muted mb-0">
                @if (_hubConnection?.State == HubConnectionState.Connected)
                {
                    <span class="badge bg-success me-2">
                        <i class="bi bi-broadcast"></i> Live
                    </span>
                }
                else
                {
                    <span class="badge bg-warning me-2">
                        <i class="bi bi-broadcast"></i> Connecting...
                    </span>
                }
                <span>@_totalCount submissions awaiting review</span>
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick="RefreshAsync">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" placeholder="Submission # or Insured name..."
                           @bind="_searchTerm" @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" @bind="_selectedStatus" @bind:after="LoadSubmissionsAsync">
                        <option value="">All Statuses</option>
                        <option value="Received">Received</option>
                        <option value="Scored">Scored</option>
                        <option value="UnderReview">Under Review</option>
                        <option value="InformationRequested">Information Requested</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" @bind="_sortBy" @bind:after="LoadSubmissionsAsync">
                        <option value="received">Date Received</option>
                        <option value="appetite">Appetite Score</option>
                        <option value="winnability">Winnability Score</option>
                        <option value="quality">Data Quality</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" @onclick="ClearFilters">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (_loading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_submissions.Count == 0)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No submissions found matching your criteria.
        </div>
    }
    else
    {
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Submission #</th>
                            <th>Insured</th>
                            <th>Coverages</th>
                            <th>TIV</th>
                            <th class="text-center">Appetite</th>
                            <th class="text-center">Winnability</th>
                            <th class="text-center">Data Quality</th>
                            <th>Status</th>
                            <th>Received</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var submission in _submissions)
                        {
                            <tr class="@(IsNewSubmission(submission.Id) ? "table-info" : "")">
                                <td>
                                    <a href="submissions/@submission.Id" class="fw-semibold text-decoration-none">
                                        @submission.SubmissionNumber
                                    </a>
                                </td>
                                <td>@submission.InsuredName</td>
                                <td>
                                    <span class="badge bg-secondary">@submission.CoverageCount coverages</span>
                                </td>
                                <td>@FormatCurrency(submission.TotalInsuredValue)</td>
                                <td class="text-center">
                                    <span class="badge @GetScoreBadgeClass(submission.AppetiteScore) px-3">
                                        @(submission.AppetiteScore?.ToString() ?? "-")
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge @GetScoreBadgeClass(submission.WinnabilityScore) px-3">
                                        @(submission.WinnabilityScore?.ToString() ?? "-")
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge @GetQualityBadgeClass(submission.DataQualityScore) px-3">
                                        @(submission.DataQualityScore?.ToString() ?? "-")
                                    </span>
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(submission.Status)">
                                        @FormatStatus(submission.Status)
                                    </span>
                                </td>
                                <td>@submission.ReceivedAt.ToString("g")</td>
                                <td>@(submission.AssignedUnderwriterName ?? "-")</td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="submissions/@submission.Id">
                                                    <i class="bi bi-eye me-2"></i>View Details
                                                </a>
                                            </li>
                                            <li>
                                                <button class="dropdown-item" @onclick="() => AssignToMe(submission.Id)">
                                                    <i class="bi bi-person-plus me-2"></i>Assign to Me
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider" /></li>
                                            <li>
                                                <button class="dropdown-item text-success" @onclick="() => QuickQuote(submission.Id)">
                                                    <i class="bi bi-check-circle me-2"></i>Quick Quote
                                                </button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-danger" @onclick="() => QuickDecline(submission.Id)">
                                                    <i class="bi bi-x-circle me-2"></i>Quick Decline
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @if (_totalPages > 1)
        {
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(_currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(_currentPage - 1)">Previous</button>
                    </li>
                    @for (int i = 1; i <= _totalPages; i++)
                    {
                        var pageNum = i;
                        <li class="page-item @(pageNum == _currentPage ? "active" : "")">
                            <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                        </li>
                    }
                    <li class="page-item @(_currentPage == _totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(_currentPage + 1)">Next</button>
                    </li>
                </ul>
            </nav>
        }
    }
</div>

@code {
    private HubConnection? _hubConnection;
    private bool _loading = true;
    private List<SubmissionSummaryDto> _submissions = [];
    private HashSet<Guid> _newSubmissionIds = [];
    private string _searchTerm = "";
    private string _selectedStatus = "";
    private string _sortBy = "received";
    private int _currentPage = 1;
    private int _pageSize = 20;
    private int _totalCount;
    private int _totalPages;

    protected override async Task OnInitializedAsync()
    {
        await LoadSubmissionsAsync();
        await StartHubConnectionAsync();
    }

    private async Task StartHubConnectionAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/hubs/submissions"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<object>("NewSubmission", async (data) =>
        {
            await InvokeAsync(async () =>
            {
                await LoadSubmissionsAsync();
                StateHasChanged();
            });
        });

        _hubConnection.On<object>("QueueUpdated", async (data) =>
        {
            await InvokeAsync(async () =>
            {
                await LoadSubmissionsAsync();
                StateHasChanged();
            });
        });

        _hubConnection.On<object>("SubmissionAssigned", async (data) =>
        {
            await InvokeAsync(async () =>
            {
                await LoadSubmissionsAsync();
                StateHasChanged();
            });
        });

        try
        {
            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error connecting to hub: {ex.Message}");
        }
    }

    private async Task LoadSubmissionsAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            SubmissionStatus? status = null;
            if (!string.IsNullOrEmpty(_selectedStatus) && Enum.TryParse<SubmissionStatus>(_selectedStatus, out var parsedStatus))
            {
                status = parsedStatus;
            }

            var result = await Mediator.Send(new GetSubmissionsQuery
            {
                Status = status,
                SearchTerm = string.IsNullOrWhiteSpace(_searchTerm) ? null : _searchTerm,
                Page = _currentPage,
                PageSize = _pageSize
            });

            if (result.IsSuccess && result.Value is not null)
            {
                _submissions = result.Value.Items.ToList();
                _totalCount = result.Value.TotalCount;
                _totalPages = result.Value.TotalPages;

                // Sort locally based on selection
                _submissions = _sortBy switch
                {
                    "appetite" => _submissions.OrderByDescending(s => s.AppetiteScore ?? 0).ToList(),
                    "winnability" => _submissions.OrderByDescending(s => s.WinnabilityScore ?? 0).ToList(),
                    "quality" => _submissions.OrderByDescending(s => s.DataQualityScore ?? 0).ToList(),
                    _ => _submissions.OrderByDescending(s => s.ReceivedAt).ToList()
                };
            }
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshAsync()
    {
        await LoadSubmissionsAsync();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _currentPage = 1;
            await LoadSubmissionsAsync();
        }
    }

    private async Task ClearFilters()
    {
        _searchTerm = "";
        _selectedStatus = "";
        _sortBy = "received";
        _currentPage = 1;
        await LoadSubmissionsAsync();
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= _totalPages)
        {
            _currentPage = page;
            await LoadSubmissionsAsync();
        }
    }

    private bool IsNewSubmission(Guid id) => _newSubmissionIds.Contains(id);

    private void AssignToMe(Guid submissionId)
    {
        Navigation.NavigateTo($"/submissions/{submissionId}/assign");
    }

    private void QuickQuote(Guid submissionId)
    {
        Navigation.NavigateTo($"/submissions/{submissionId}?action=quote");
    }

    private void QuickDecline(Guid submissionId)
    {
        Navigation.NavigateTo($"/submissions/{submissionId}?action=decline");
    }

    private static string FormatCurrency(decimal? value) =>
        value.HasValue ? value.Value.ToString("C0") : "-";

    private static string FormatStatus(string status) => status switch
    {
        "UnderReview" => "Under Review",
        "InformationRequested" => "Info Requested",
        _ => status
    };

    private static string GetScoreBadgeClass(int? score) => score switch
    {
        >= 80 => "bg-success",
        >= 60 => "bg-warning text-dark",
        >= 40 => "bg-secondary",
        _ => "bg-danger"
    };

    private static string GetQualityBadgeClass(int? score) => score switch
    {
        >= 90 => "bg-success",
        >= 70 => "bg-info",
        >= 50 => "bg-warning text-dark",
        _ => "bg-danger"
    };

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "Received" => "bg-info",
        "Scored" => "bg-primary",
        "UnderReview" => "bg-warning text-dark",
        "Quoted" => "bg-success",
        "Declined" => "bg-danger",
        "InformationRequested" => "bg-secondary",
        _ => "bg-light text-dark"
    };

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
