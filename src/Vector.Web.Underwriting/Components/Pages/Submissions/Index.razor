@page "/submissions"
@using MediatR
@using Vector.Application.Submissions.DTOs
@using Vector.Application.Submissions.Queries
@using Vector.Domain.Submission.Enums
@inject IMediator Mediator
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>All Submissions - Vector</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>All Submissions</h1>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" placeholder="Submission # or Insured name..."
                           @bind="_searchTerm" @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" @bind="_selectedStatus" @bind:after="LoadSubmissionsAsync">
                        <option value="">All Statuses</option>
                        <option value="Received">Received</option>
                        <option value="Scored">Scored</option>
                        <option value="UnderReview">Under Review</option>
                        <option value="Quoted">Quoted</option>
                        <option value="Declined">Declined</option>
                        <option value="Bound">Bound</option>
                        <option value="InformationRequested">Information Requested</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" @onclick="LoadSubmissionsAsync">
                        <i class="bi bi-search me-1"></i>Search
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" @onclick="ClearFilters">
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (_loading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_submissions.Count == 0)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No submissions found matching your criteria.
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Showing @_submissions.Count of @_totalCount submissions</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Submission #</th>
                            <th>Insured</th>
                            <th>Effective Date</th>
                            <th>Coverages</th>
                            <th>TIV</th>
                            <th class="text-center">Scores</th>
                            <th>Status</th>
                            <th>Assigned To</th>
                            <th>Received</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var submission in _submissions)
                        {
                            <tr class="cursor-pointer" @onclick="() => ViewSubmission(submission.Id)">
                                <td>
                                    <a href="submissions/@submission.Id" class="fw-semibold text-decoration-none">
                                        @submission.SubmissionNumber
                                    </a>
                                </td>
                                <td>@submission.InsuredName</td>
                                <td>@(submission.EffectiveDate?.ToString("d") ?? "-")</td>
                                <td>@submission.CoverageCount</td>
                                <td>@FormatCurrency(submission.TotalInsuredValue)</td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-1">
                                        <span class="badge @GetScoreBadgeClass(submission.AppetiteScore)" title="Appetite">
                                            A:@(submission.AppetiteScore?.ToString() ?? "-")
                                        </span>
                                        <span class="badge @GetScoreBadgeClass(submission.WinnabilityScore)" title="Winnability">
                                            W:@(submission.WinnabilityScore?.ToString() ?? "-")
                                        </span>
                                        <span class="badge @GetQualityBadgeClass(submission.DataQualityScore)" title="Data Quality">
                                            Q:@(submission.DataQualityScore?.ToString() ?? "-")
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(submission.Status)">
                                        @FormatStatus(submission.Status)
                                    </span>
                                </td>
                                <td>@(submission.AssignedUnderwriterName ?? "-")</td>
                                <td>@submission.ReceivedAt.ToString("g")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @if (_totalPages > 1)
        {
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(_currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(_currentPage - 1)">Previous</button>
                    </li>
                    @for (int i = Math.Max(1, _currentPage - 2); i <= Math.Min(_totalPages, _currentPage + 2); i++)
                    {
                        var pageNum = i;
                        <li class="page-item @(pageNum == _currentPage ? "active" : "")">
                            <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                        </li>
                    }
                    <li class="page-item @(_currentPage == _totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(_currentPage + 1)">Next</button>
                    </li>
                </ul>
            </nav>
        }
    }
</div>

@code {
    private bool _loading = true;
    private List<SubmissionSummaryDto> _submissions = [];
    private string _searchTerm = "";
    private string _selectedStatus = "";
    private int _currentPage = 1;
    private int _pageSize = 25;
    private int _totalCount;
    private int _totalPages;

    protected override async Task OnInitializedAsync()
    {
        await LoadSubmissionsAsync();
    }

    private async Task LoadSubmissionsAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            SubmissionStatus? status = null;
            if (!string.IsNullOrEmpty(_selectedStatus) && Enum.TryParse<SubmissionStatus>(_selectedStatus, out var parsedStatus))
            {
                status = parsedStatus;
            }

            var result = await Mediator.Send(new GetSubmissionsQuery
            {
                Status = status,
                SearchTerm = string.IsNullOrWhiteSpace(_searchTerm) ? null : _searchTerm,
                Page = _currentPage,
                PageSize = _pageSize
            });

            if (result.IsSuccess && result.Value is not null)
            {
                _submissions = result.Value.Items.ToList();
                _totalCount = result.Value.TotalCount;
                _totalPages = result.Value.TotalPages;
            }
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _currentPage = 1;
            await LoadSubmissionsAsync();
        }
    }

    private async Task ClearFilters()
    {
        _searchTerm = "";
        _selectedStatus = "";
        _currentPage = 1;
        await LoadSubmissionsAsync();
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= _totalPages)
        {
            _currentPage = page;
            await LoadSubmissionsAsync();
        }
    }

    private void ViewSubmission(Guid id)
    {
        Navigation.NavigateTo($"/submissions/{id}");
    }

    private static string FormatCurrency(decimal? value) =>
        value.HasValue ? value.Value.ToString("C0") : "-";

    private static string FormatStatus(string status) => status switch
    {
        "UnderReview" => "Under Review",
        "InformationRequested" => "Info Requested",
        _ => status
    };

    private static string GetScoreBadgeClass(int? score) => score switch
    {
        >= 80 => "bg-success",
        >= 60 => "bg-warning text-dark",
        >= 40 => "bg-secondary",
        _ => "bg-danger"
    };

    private static string GetQualityBadgeClass(int? score) => score switch
    {
        >= 90 => "bg-success",
        >= 70 => "bg-info",
        >= 50 => "bg-warning text-dark",
        _ => "bg-danger"
    };

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "Received" => "bg-info",
        "Scored" => "bg-primary",
        "UnderReview" => "bg-warning text-dark",
        "Quoted" => "bg-success",
        "Declined" => "bg-danger",
        "Bound" => "bg-dark",
        "InformationRequested" => "bg-secondary",
        _ => "bg-light text-dark"
    };
}
