@page "/submissions"
@using MediatR
@using Vector.Application.Submissions.DTOs
@using Vector.Application.Submissions.Queries
@using Vector.Domain.Submission.Enums
@using Vector.Web.Producer.Components.Shared
@inject IMediator Mediator
@attribute [Authorize]

<PageTitle>My Submissions</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>My Submissions</h1>
            <p class="text-muted">Track and manage your insurance submission requests</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" placeholder="Search by submission # or insured name..."
                       @bind="searchTerm" @bind:event="oninput" @onkeyup="HandleSearchKeyUp" />
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch">
                        Clear
                    </button>
                }
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedStatus" @bind:after="LoadSubmissions">
                <option value="">All Statuses</option>
                @foreach (var status in Enum.GetValues<SubmissionStatus>())
                {
                    <option value="@status">@status</option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" @onclick="LoadSubmissions">
                Refresh
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Submissions</h5>
                    <h2 class="card-text">@result?.TotalCount</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">In Review</h5>
                    <h2 class="card-text">@(result?.Submissions.Count(s => s.Status == "InReview") ?? 0)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Pending Info</h5>
                    <h2 class="card-text">@(result?.Submissions.Count(s => s.Status == "PendingInformation") ?? 0)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Quoted/Bound</h5>
                    <h2 class="card-text">@(result?.Submissions.Count(s => s.Status is "Quoted" or "Bound") ?? 0)</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (result is null || !result.Submissions.Any())
    {
        <div class="alert alert-info">
            <h4 class="alert-heading">No submissions found</h4>
            <p>You don't have any submissions matching the current filters.</p>
        </div>
    }
    else
    {
        <!-- Submissions Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Submission #</th>
                                <th>Insured</th>
                                <th>Status</th>
                                <th>Received</th>
                                <th>Effective Date</th>
                                <th>Underwriter</th>
                                <th>Scores</th>
                                <th>Coverage</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var submission in result.Submissions)
                            {
                                <tr>
                                    <td>
                                        <a href="/submissions/@submission.Id">
                                            <strong>@submission.SubmissionNumber</strong>
                                        </a>
                                    </td>
                                    <td>@submission.InsuredName</td>
                                    <td>
                                        <StatusBadge Status="@submission.Status" />
                                    </td>
                                    <td>@submission.ReceivedAt.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                    <td>@(submission.EffectiveDate?.ToString("MM/dd/yyyy") ?? "TBD")</td>
                                    <td>@(submission.AssignedUnderwriterName ?? "Unassigned")</td>
                                    <td>
                                        <div class="d-flex gap-1 flex-wrap">
                                            <ScoreBadge Score="@submission.AppetiteScore" Label="A" />
                                            <ScoreBadge Score="@submission.WinnabilityScore" Label="W" />
                                            <ScoreBadge Score="@submission.DataQualityScore" Label="DQ" />
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            @submission.CoverageCount coverage(s)
                                        </span>
                                        <span class="badge bg-light text-dark">
                                            @submission.LocationCount location(s)
                                        </span>
                                    </td>
                                    <td>
                                        <a href="/submissions/@submission.Id" class="btn btn-sm btn-outline-primary">
                                            View
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        @if (result.TotalPages > 1)
        {
            <div class="mt-4">
                <Pagination CurrentPage="@result.Page"
                           TotalPages="@result.TotalPages"
                           TotalCount="@result.TotalCount"
                           OnPageChanged="HandlePageChanged" />
            </div>
        }
    }
</div>

@code {
    private ProducerSubmissionsResult? result;
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private SubmissionStatus? selectedStatus;
    private int currentPage = 1;
    private const int PageSize = 20;

    protected override async Task OnInitializedAsync()
    {
        await LoadSubmissions();
    }

    private async Task LoadSubmissions()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var query = new GetProducerSubmissionsQuery(
                ProducerId: null, // Will be filtered by tenant
                Status: selectedStatus,
                SearchTerm: string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
                Page: currentPage,
                PageSize: PageSize);

            result = await Mediator.Send(query);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            currentPage = 1;
            await LoadSubmissions();
        }
    }

    private async Task ClearSearch()
    {
        searchTerm = string.Empty;
        currentPage = 1;
        await LoadSubmissions();
    }

    private async Task HandlePageChanged(int page)
    {
        currentPage = page;
        await LoadSubmissions();
    }
}
